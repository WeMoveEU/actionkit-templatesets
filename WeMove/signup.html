{% extends "./wrapper.html" %}

{% block content %}

<form class="ak-form" name="act" method="POST" action="/act/" accept-charset="utf-8">
  <input type="hidden" name="page" value="{{ page.name }}">

	<div class="ak-grid-row">

		<div class="advice-advice" id="signup-story">
			<div class="action-advice-col">
				{% include "./language_picker.html" %}
				<div class="advice-container">
					<h1>{{ page.title }}</h1>

					{% if page.custom_fields.featured_image %}
					  <img class="ak-featured-img {% if page.goal %}ak-margin-top-1{% endif %}" src="{{page.custom_fields.featured_image}}">
					{% elif page.custom_fields.featured_video %}
            <div class="video-container">
                <iframe width="560" height="315" src="{{page.custom_fields.featured_video}}"></iframe>
            </div>
          {% endif %}

          {% if form.statement_leadin %}
					<div class="well">
						{% include_tmpl form.statement_leadin %}
					</div>
					{% endif %}

          <div class="ak-abovefold">
            {% include_tmpl form.introduction_text %}
          </div>
			</div>
		</div>

		<div class="action-form-container-col ak-grid-col ak-grid-col-4-of-12" id="action-form-container-col">

			<div class="action-form">
				<div id="action-form-container-id" class="action-form-container">

					<div class="ak-field-box ak-field-box-borderless">

						<div id="petition-form" class="ak-styled-fields ak-labels-overlaid ak-errs-below">
							{% include "./user_form_wrapper.html" %}
						</div>

					</div>
					<div class="privacy-statement">
						{% filter ak_text:"form_signTerms_disclaimer" %}By clicking “Sign” you are supporting this campaign, and agreeing to WeMove Europe using your information for the purpose of this campaign. We might hand over your name, surname and country to the petition target. Unless you subscribe to receive personalised updates, we will delete your data after the campaign has ended. We will never share your data with any third parties without your permission. See our full privacy policy <a href="https://www.wemove.eu/privacy-policy" target="_blank">here</a>.{% endfilter %}
					</div>
				</div>

			</div>

			<aside class="recent-comments" style="display: none">
				<h4>Recent comments</h4>
				<div class="recent-comment">
					<div class="recent-comment-by" style="font-style: italic;"></div>
					<div class="recent-comment-text"></div>
				</div>
			</aside>
		</div>
	</div>
</form>

<script>
	var recent_comments = {% report "comments_recent_actions" with page.id as page_id %};
	recent_comments.shift();

	window.currentCommentIndex = 0;
	window.recentCommentShown = false;
	window.comment_elt = $('.recent-comments .recent-comment');
	$( function () {
		if (comment_elt.length > 0) {
			if (recent_comments.length && !recentCommentShown) {
				recentCommentShown = true;
				comment_elt.parent().fadeIn('slow');
				cycleRecentComment();
			}
		}
	} );

	function cycleRecentComment() {
		comment_elt.fadeOut('slow', function() {
			var comment = recent_comments[currentCommentIndex ++ % recent_comments.length];
			comment_elt.find('.recent-comment-by').text(comment[0]);
			comment_elt.find('.recent-comment-text').text(comment[1]);
			comment_elt.removeClass('hidden');
			comment_elt.fadeIn('slow');
			var duration = Math.ceil(comment[1].split(' ').length * 0.2);
            if (duration < 3) { duration = 3; }
			setTimeout(cycleRecentComment, duration * 1000);
		});
	}
</script>

<div class="js-recent-action" style="display: none">
    <i class="glyphicon glyphicon-thumbs-up"></i>
		<span class="js-text"></span>
</div>

<script>
	var recent_signers = {% report "names_recent_actions" with page.id as page_id %};
	recent_signers.shift();
	recent_signers = recent_signers.map( n => [ n[0], n[1] + " has just signed the petition" ] );

	var recent_sharers = {% report "names_recent_shares" with page.id as page_id %};
	recent_sharers.shift();
	recent_sharers = recent_sharers.map( n => [ n[0], n[1] + " just shared this on " + n[2] ] );

	var recent_actions = recent_signers.concat( recent_sharers );
	recent_actions = recent_actions.sort( function compare(a,b) {
		if ( a[0] < b[0] ) { return 1 }
		if ( a[0] > b[0] ) { return -1 }
		return 0
	} );

	window.recentActions = recent_actions.map( n => n[1] );

	window.currentActionIndex = 0;
	window.recentActionShown = false;
	window.recent_action_elt = $('.js-recent-action');
	$( function () {
		if (recent_action_elt.length > 0) {
			if (window.innerWidth > 1180) {
				if (recentActions.length && ! recentActionShown) {
					recentActionShown = true;
					cycleRecentAction();
				}
			}
		}
	} );

	function cycleRecentAction() {
		recent_action_elt.fadeOut('slow', function() {
			var signer = recentActions[currentActionIndex ++ % recentActions.length];
			recent_action_elt.find('.js-text').text(signer);
			recent_action_elt.removeClass('hidden');
			recent_action_elt.fadeIn('slow');
			setTimeout(cycleRecentAction, 5000);
		});
	}

</script>

{% endblock %}
