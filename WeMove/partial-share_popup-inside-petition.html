{% if page.custom_fields.daisy_chain_action %}
    {% remember page.custom_fields.daisy_chain_action as pageName %}
  {% else %}
    {% remember page.name as pageName %}
  {% endif %}

  <script async>
  let sharePageUrl, akid, actionId;

  const loadPopupScript = () => {
    document.removeEventListener("wm-scriptsLoaded", loadPopupScript);

    {% if args.test %}
    wemove.triggerEvent("wm-openDialog", { querySelector: "data-wm-share-popup"});
    {% endif %}
  };

  const updateShareLinks = () => {
    const akParams = `akid=${akid}&amp;action_id=${actionId}`;
    const dialog = document.querySelector("[data-wm-dialog-content]");
    const updatedHTML = dialog.innerHTML.replaceAll("akid=None", akParams);
    dialog.innerHTML = updatedHTML;

    wemove.triggerEvent("wm-initShare");
  };

  const redirectToSharePage = () => {
    window.location.href = sharePageUrl;
  };

  const signPetition = async () => {
    wemove.triggerEvent("wm-showPreloader");

    const form = document.getElementById("petition-form");
    const payload = new URLSearchParams(new FormData(form));

    await fetch("/act/", {
      method: "POST",
      body: payload,
    }).then((response) => {
      actionId = response.url.split("action_id=")[1].split("&")[0];
      akid = response.url.split("akid=")[1].split("&")[0];
      sharePageUrl = response.url;

      wemove.triggerEvent("wm-hidePreloader");
      wemove.triggerEvent("wm-openDialog", { querySelector: "data-wm-share-popup"});
    }).catch((error) => {
      form.submit();
    });
  };

  // INIT POPUP JS
  document.addEventListener("wm-scriptsLoaded", loadPopupScript);
  document.addEventListener("wm-dialogClosed", redirectToSharePage);
  document.addEventListener("wm-dialogOpened::data-wm-share-popup", updateShareLinks);

  let wasAKSubmitInjected = false;
  window.actionkitBeforeSubmit = () => {
    // we need this flag because ActionKit calls this function twice.
    // the duplication comes from pixel-loader trying to validate
    if (wasAKSubmitInjected) {
      return false;
    }

    signPetition();
    wasAKSubmitInjected = true;

    return false;
  };
</script>

<div data-wm-share-popup hidden>
  <div class="mx-auto md:max-w-[500px] text-wm-purple">
    <h3 class="text-3xl mb-2">
      {% filter ak_text:"sharePopup_title" %}Share this petition{% endfilter %}
    </h3>

    {% if page.custom_fields.featured_image or page.followup.share_image_value %}
        <img
          class="mb-3"
          width="100%"
          height="100%"
          alt="{{ page.followup.share_title_value }}"
          src="{{ page.custom_fields.featured_image|default:page.followup.share_image_value }}" />
    {% endif %}

    <div {% if args.test %}{% else %}class="[&_div]:border-white [&_div]:mb-3 [&_div]:p-0 [&_div:last-child]:mb-0"{% endif %}>
      {% include "./component-share_button_whatsapp.html" %}
      {% include "./component-share_button_facebook.html" %}
      {% include "./component-share_button_bluesky.html" %}
      {% include "./component-share_button_instagram.html" %}
      {% include "./component-share_button_taf.html" %}
      {% include "./component-share_button_copy_url.html" %}
    </div>
  </div>
</div>