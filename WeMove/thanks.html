{% extends "./wrapper.html" %}

{% block pre_action_share %}{% endblock %}

{% block content %}

{% if actionkit_user %}
  {% if recurring_update or recurring_cancel %}
    <div class="ak-grid-row" style="padding: 0 1rem;">
      <div class="ak-grid-col ak-grid-col-12-of-12">
        <p>
          {% filter ak_text:"logged_in_as" %}You are logged in as{% endfilter %} <a href="/me/">{{ actionkit_user.name|escape }}</a>.
          <a href="/logout">{% filter ak_text:"logout" %}Click to log out.{% endfilter %}</a>
        </p>
      </div>
    </div>
  {% endif %}
{% endif %}

{% if args.done %}
  {# --- VIEW MODE "DONE" #}
  <div class="thanks-message">
    {% if page.custom_fields.final_message %}
      <div>{{ page.custom_fields.final_message|safe }}</div>
    {% else %}
      {% filter ak_text:"final_message" %}
        Thank you for standing for democracy with us. It is only together that we can truly be a force to be reckoned with.
      {% endfilter %}
    {% endif %}

    <div class="go-home">
      <a href="https://wemove.eu/{{ link_iso }}">
        {% filter ak_text:"returnToHomepage_link" %}Return to the homepage{% endfilter %}
      </a>
    </div>
  </div>

{% elif args.share or share_mode %}
  <form name="taf" method="POST" action="/update_action/" accept-charset="utf-8" class="ak-thanks ak-styled-fields">
    <input type="hidden" name="page" value="{{ page.name }}">

    {% if page.send_via_cwc and page.is_targeting_us_senate and not action.custom_fields.cwc_prefix %}

      {# --- VIEW MODE "AFTER-ACTION, NAME PREFIX FOR US SENATE" #}

      <div class="ak-grid-row" style="padding: 0 1rem;">
        <div class="ak-grid-col ak-grid-col-6-of-12">
          <h1>
            Information Needed
          </h1>
          <div>
            <p>To deliver your signature to the Senate <b>you must select a prefix</b> from the following list.  Your selection will only be used to deliver your signature.</p>
            <select name="action_cwc_prefix">
              <option>Mr.</option>
              <option>Mrs.</option>
              <option>Miss</option>
              <option>Ms.</option>
              <option>Dr.</option>
            </select>
            <button type="submit" class="ak-submit-button">Update</button>
          </div>
        </div>
      </div>

    {% elif page.SUPPRESS_SHARING %}

	    {# --- VIEW MODE "AFTER-ACTION, NO SHARING" #}

      <div class="ak-grid-row" style="padding: 0 1rem;">
        <div class="ak-grid-col ak-grid-col-12-of-12">
          <div class="thanks-header">
            <img src="/media/modern/stance-supportive.svg" height="34" width="34" class="ak-checkmark-icon" alt="&#10003;">
            <h2>{% filter ak_text:"noshare_thanks_banner" %}Thanks!{% endfilter %}</h2>
          </div>

          <div>{% include_tmpl form.thank_you_text %}</div>

          {% if not page.type == 'Unsubscribe' %}
          <a href="{% if page.custom_fields.next_step %}/act/{{ page.custom_fields.next_step }}{% else %}/thanks/{{ page.name }}?done=1&amp;{% endif %}akid={{ akid }}{% if action %}&amp;action_id={{ action.id }}{% endif %}" class="skip btn btn-default"> {% filter ak_text:"skipStep_button" %}Skip this step{% endfilter %}</a>
          {% endif %}
        </div>
      </div>

    {% else %}

      {# --- VIEW MODE "SHARING" #}

      {# TODO Logic and partials to be removed after germanic ab test is done #}
      {% if user and user.country == 'Germany' or user.country == 'Austria' or user.country|lower == 'de' or user.country|lower == 'at' %}
        {% if args.skip_abtest == "1" %}
          {% include "./share-standard.html" %}
        {% elif page.custom_fields.germanic_ab_test_mode == "campact" %}
          {% include "./share-campact.html" %}
        {% elif page.custom_fields.germanic_ab_test_mode == "innnit" %}
          {% include "./share-innnit.html" %}
        {% else %}
          {% include "./share-standard.html" %}
        {% endif %}
      {% else %}
        {% include "./share-standard.html" %}
      {% endif %}

	  {% endif %}
  </form>
{% else %}

	<!--
    Let AK know that we support sharing by always consistently including these two
    substrings in our page source, but we don't actually use it here:
      /share/link?type=fb
      /share/link?type=tw
  -->

	{# --- VIEW UNCERTAIN; DETERMINE NEXT STEP #}

	{% store as destination %}{% filter strip %}
		{% if page.custom_fields.next_step %}
			{% if "//" in page.custom_fields.next_step %}
				{{ page.custom_fields.next_step }}{% if "?" not in page.custom_fields.next_step %}?{% endif %}
			{% else %}
				/act/{{ page.custom_fields.next_step }}?
			{% endif %}
		{% else %}
			/thanks/{{ page.custom_fields.daisy_chain_action|default:page.name }}?share=1&
		{% endif %}
	{% endfilter %}{% endstore %}

	{% store as next_step %}{% filter strip %}
		{{ destination }}akid={{ akid }}{% if action %}&action_id={{ action.id }}{% endif %}
	{% endfilter %}{% endstore %}
	<!-- Daisy Chain: {{ page.custom_fields.daisy_chain_action }} -->
	<!-- Next Step: {{ next_step }} -->


  {# --- BEFORE GOING TO NEXT STEP, ASK FOR CONSENT TO SUBSCRIBE NEW USERS #}

  {% comment %}
		There are five cases where we skip consent and go to your next destination:
		1. unidentified user, so we can't subscribe
		2. already subscribed, so don't ask again
		3. is an unsubscribe page, so we shouldn't re-subscribe
		4. user was recently shown this consent page, so don't ask again
		5. we can't figure out which consent page to use.

		If you pass all of those, we send you to the consent page along with
		a link to your next destination.
  {% endcomment %}

  <!-- Substatus: {{ user.subscription_status }} -->

  {% if not user %}

    {# 1. We don't know who you are, so we can't deal with consents. #}
    <a href="{{ next_step }}">Please continue to the next step.</a>
    <script>
      window.location = '{{ next_step }}&consent=anonymous';
    </script>

  {% elif user.subscription_status == 'subscribed' %}

    {# 2. You already subscribed, so jump to the next step. #}
    <a href="{{ next_step }}">Please continue to the next step.</a>
    <script>
      window.location = '{{ next_step }}&consent=already';
    </script>

  {% elif page.type == 'Unsubscribe' %}

    {# 3. You're taking action on a page that doesn't require consents. #}
    <a href="{{ next_step }}">Please continue to the next step.</a>
    <script>
      window.location = '{{ next_step }}&consent=bypass';
    </script>

  {% else %}

    {% store as previous_consents %}{% report "previous_user_consent_for_list" with 1 as refresh user.id as user_id page.list_id as list_id %}{% endstore %}
    <!-- Previous consents: {{ previous_consents }} -->

    {% if previous_consents != "" and previous_consents != "0" %}

      {# 4. You have already been asked to consent, so jump to the next step. #}

      <a href="{{ next_step }}">Please continue to the next step.</a>
      <script>
        window.location = '{{ next_step }}&consent=previous';
      </script>

    {% else %}

      <!-- Lang ID: {{ user.lang_id }} -->
      {% store as signup_page_name %}{% report "signup_page_for_list_language" with 1 as refresh page.list_id as list_id user.lang_id|default:100 as lang_id %}{% endstore %}
      <!-- Signup Page: {{ signup_page_name }} -->
      {% if not signup_page_name %}
        {% comment %}
          5. You should be asked to consent, but we don't have a consent page
          for that list in your language, so jump to the next step.
        {% endcomment %}

        <a href="{{ next_step }}">Please continue to the next step.</a>
        <script>
          window.location = '{{ next_step }}&consent=nolang';
        </script>

      {% else %}

        {% store as consent_link %}/act/{{ signup_page_name }}?akid={{ akid }}{% if action %}&trigger_page={{ page.name }}&trigger_action={{ action.id }}{% endif %}&next_step={{ next_step|urlencode }}{% endstore %}

        {# TODO: To be removed when ab test is done (Consent inline) #}
        {% if page.custom_fields.inline_consent == "1" %}
          {% if user and user.country == 'Germany' or user.country == 'Austria' or user.country|lower == 'de' or user.country|lower == 'at' %}
            <script>
              window.location = '{{ consent_link }}';
            </script>
          {% else %}
            <script>
              window.location = '{{ next_step }}';
            </script>
          {% endif %}
        {% endif %}

      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}

{% block below_form %}
<script>
    actionkit.forms.contextRoot = '/context/';
    actionkit.forms.initTafForm('taf');
    actionkit.sharing.initShareTools();
</script>
{% endblock %}
