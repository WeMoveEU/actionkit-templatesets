{% extends "./wrapper.html" %}
{% load humanize %}

{% comment %} 

Update your recurring donation
=================================

There are a couple ways to update a recurring donation:

 - Change the amount (upscaling). DONE.
 - Change the payment method.     TODO.

{% endcomment %}

{% block css_additions %}
<link rel="stylesheet" href="https://donate-ui.not-a2.eu/donate-main.css" />

{% endblock %}

{% block script_additions %}
{% endblock %}

{% block content %}

<div class="ak-grid-row">
    <div class="ak-grid-col ak-grid-col-12-of-12">
        <h2>{{ page.title }}</h2>
    </div>
</div>

<div class="ak-grid-row ak-grid-row-inverted">
    {% if page.custom_fields.featured_image %}
        <div class="ak-grid-col ak-grid-col-3-of-12">
            <img class="ak-featured-img" src="{{page.custom_fields.featured_image}}" alt="main picture" />
        </div>
    {% endif %}
    <div class="ak-grid-col {% if page.custom_fields.featured_image %} ak-grid-col-9-of-12 {% else %}ak-grid-col-12-of-12 {% endif %}">

        <div>
            <p>Hello {{ logged_in_user.name }} ! If you're not {{ logged_in_user.name }}, please <a href="/logout/">click here.</a></p>
        </div>

        <div style="display:none">{% comment %}actionkit.js wants this, but we don't{% endcomment %}
            <p id="unknown_user"></p>
            <div id="known_user"><span id="known_user_name"></span></div>
        </div>

        <p>{% include_tmpl form.update_card_text %}</p>

        {% store as profile_details %}
        {% report "recurring_profile" with args.profile as recurring_id logged_in_user.id as user_id %}
        {% endstore %}

        {% with profile_details|load_json as profile %}

        {% if action %}

            <h3>Update saved!</h3>
            <div>
                {% include_tmpl form.thank_you_text %}
            </div>

            {% else %}

            <div style="display: none;">
                <form id="actionkit-form" name="act" action="/act/" method="POST">
                    <input type="hidden" name="page" value="tracking-upscaled-donations-{{ page.lang.iso_code }}" />
                    <input type="hidden" name="akid" value="{{ logged_in_user.token }}" />
                    <input type="hidden" name="action_upscale_page" value="{{ page.name }}" />
                    <input type="hidden" name="action_profile" value="{{ profile.id }}" />
                    <input type="hidden" name="action_recurring_id" value="{{ profile.recurring_id }}" />
                    <input type="hidden" name="action_upscale_amount" value="" />
                    <input type="hidden" name="action_upscale_currency" value="{{ profile.currency }}" />
                    <input type="hidden" name="action_upscale_previous_amount" value="{{ profile.amount }}" />
                </form>
            </div>

            <div id="confirm-amount-change">

            {% for amount in args.amounts|split:',' %}
                <div style="padding: 1em;">
                <div
                    class="donate-widget"
                    data-ak_locale="en"
                    data-akid="{{ logged_in_user.token }}"
                    data-mode="change"
                    data-recurring_id="{{ args.profile }}"
                    data-change_amount="{{ amount }}"
                    data-selected_currency="{{ args.currency }}"
                    ></div>
                </div>
            {% endfor %}

            </div>

            <script>
                document.addEventListener('payment-update', (evt) => {
                    const form = document.getElementById('actionkit-form');
                    console.debug(evt);
                    // TODO: evt.amount is just a made-up placeholder, update to whatever the 
                    //       widget actually sends.
                    form.action_upscale_amount.value = evt.amount;
                    form.submit();
                })
            </script>


        {% endif %}

        {% endwith %}


    </div>

</div>
<script type="module" src="https://donate-ui.not-a2.eu/donate-main.js"></script>
{% endblock %}
