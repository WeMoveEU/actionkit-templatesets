{% extends "./wrapper.html" %}

{% block content %}

  <h1 class="mb-2">Your account</h1>

  <menu data-wm-tab class="mb-8 border-b-2 relative font-gilroy text-lg">
    <div class="flex justify-start gap-2 -bottom-0.5 relative">
      <button data-wm-tab-button="account" class="text-gray-600 border-b-2 [&.active]:border-wm-pink [&.active]:text-wm-purple p-2 active" type="button">Account</button>
      <button data-wm-tab-button="donations" class="text-gray-600 border-b-2 [&.active]:border-wm-pink [&.active]:text-wm-purple p-2" type="button">Donations</button>
    </div>
  </menu>

  <script>
    $(document).ready(()=>{
      const tabs = document.querySelector('[data-wm-tab]');
      const tabButtons = [...tabs.querySelectorAll('[data-wm-tab-button]')];
      const tabSections = [...document.querySelectorAll('[data-wm-tab-section]')];

      const toggleTab = (event) => {
        const activeTabSection = event.currentTarget.dataset.wmTabButton;

        tabButtons.forEach((button) => {
          button.classList.toggle('active', button.dataset.wmTabButton === activeTabSection);
        });

        tabSections.forEach((section) => {
          section.hidden = section.dataset.wmTabSection !== activeTabSection;
        });
      };

      tabButtons.forEach((button) => {
        button.addEventListener('click', toggleTab);
      });
    });
  </script>

  <section hidden data-wm-tab-section="account" class="md:grid md:grid-cols-2 gap-4 xl:w-3/5 xl:mx-auto">
    <div class="p-6 rounded-xl border-[1px] border-wm-pink text-wm-purple mb-8">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-1">
          <span aria-hidden="true" class="w-5 h-5 mr-1 inline-block not-sr-only" title="Print">
            {% include "./icon-user.html" %}
          </span>
          <span class="font-bold text-wm-purple font-gilroy text-lg">Personal data</span>
        </div>

        <button
          type="button"
          data-temp="update/"
          class="bg-wm-pink rounded block py-0 px-3 !text-white hover:brightness-110 transition-all">
          edit
        </a>
      </div>

      <ul>
        <li class="font-bold text-wm-purple mb-2">{{ actionkit_user.email }}</li>
        <li class="mb-2">{{ actionkit_user.postal }} {{ actionkit_user.country }}</li>
        <li><a href="/logout">log out</a></li>
      </ul>
    </div>

    <div class="p-6 rounded-xl border-[1px] border-wm-pink text-wm-purple mb-8">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-1">
          <span aria-hidden="true" class="w-5 h-5 mr-1 inline-block not-sr-only" title="Print">
            {% include "./icon-subscription.html" %}
          </span>
          <span class="font-bold text-wm-purple font-gilroy text-lg">Subscription history</span>
        </div>
      </div>

      <ul class="text-wm-purple">
        <li class="mb-2">
          <strong>Status:</strong>
          {% if actionkit_user.is_subscribed %}
            subscribed
          {% else %}
            unsubscribed
          {% endif %}
        </li>
        {% if actionkit_user.is_subscribed %}
          <li>
            <a href="/cms/unsubscribe/unsubscribe/?akid={{ actionkit_user.token }}">unsubscribe</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </section>

  <section !hidden data-wm-tab-section="donations" class="flex justify-center gap-6 flex-wrap lg:w-3/5 lg:mx-auto">
    <div class="p-4 rounded-xl border-[1px] border-wm-pink text-wm-purple w-full">
      {% if recurring_donations and recurring_donations|length > 1 %}
          <h2 class="text-wm-purple border-b-2 mb-4 border-b-wm-pink">Recurring donations</h2>

          <ol>
              {% for donation in recurring_donations %}
                  <li class="relative mt-2">
                    <div class="py-2 px-4 rounded-xl border-[1px] border-wm-pink">
                      <div class="text-xl font-bold text-wm-purple flex items-center gap-4">
                        {{ donation.amt }}

                        <span class="text-sm font-bold text-wm-purple">
                          {% if donation.recurring %}recurring{% else %}one off{% endif %}
                        </span>
                      </div>

                      <div class="text-xs text-gray-500">{{ donation.created_at|date:"m/d/Y" }}</div>
                    </div>

                    <button type="button" class="absolute right-4 top-4 z-10">
                      <span aria-hidden="true" class="w-6 h-6 inline-block not-sr-only" title="Print">
                        {% include "./icon-print.html" %}
                      </span>
                      <span class="text-gray-500 sr-only">print receipt</span>
                    </button>
                  </li>
              {% endfor %}
          </ol>

      {% elif recurring_donations %}
        <aside class="flex justify-between">
          <div class="flex items-center gap-1">
            <span aria-hidden="true" class="{% if profile.is_active %}bg-green-500{% else %}bg-gray-500{% endif %} rounded-full border-black inline-block h-3 w-3"></span>
            <span>{% if profile.is_active %}active{% else %}inactive{% endif %}</span>
          </div>

          {% if profile.is_active %}
            <button type="button" class="bg-gray-700 rounded block py-1 px-3 text-white hover:bg-wm-purple transition-all">
              cancel subscription
            </button>
          {% else %}
            <!-- TODO: 2.0 -->
            <button hidden type="button" class="bg-gray-700 rounded block py-1 px-3 text-white hover:bg-wm-purple transition-all">
              update subscription
            </button>
          {% endif %}
        </aside>

        <main>
          {% for profile in recurring_donations %}
            <div class="flex items-center justify-center text-4xl my-4 lowercase">
              {{ profile.amt }}
              <span class="mx-2"> / </span>
              {{ profile.get_period_display }}
            </div>

            <div class="text-center">
              <div class="mb-2">
                <h5 class="mb-0">Payment method</h5>
                <span>
                  {% if profile.account|lower == "wm-card" %}
                    Credit card
                  {% elif profile.account|lower == "wm-stripe" %}
                    Stripe
                  {% elif profile.account|lower == "wm-sepa" %}
                    Sepa
                  {% elif profile.account|lower == "wm-paypal" %}
                    Paypal
                  {% endif %}
                  </span>
              </div>

              <div>
                <h5 class="mb-0">First payment</h5>
                <span>{{ profile.first_payment_date|date }}</span>
              </div>

              {% if profile.is_active %}
                <div>
                  <h5 class="mb-0">Next payment</h5>
                  <span>{{ profile.next_payment_date|date }}</span>
                </div>
              {% else %}
                <div>
                  <h5 class="mb-0">Last payment</h5>
                  <span>{{ profile.last_payment_date|date }}</span>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </main>
      {% else %}
        <div id="never-recurring">
          <main class="text-center text-xl">
            <p>You don't have recurring donations</p>
            <a
              class="hover:!no-underline w-auto m-auto uppercase py-2 px-6 text-center text-base font-bold font-gilroy bg-wm-pink min-h-8 inline-block !text-white rounded transition-all hover:brightness-110"
              href="https://action.wemove.eu/donate/chip-in-wemove?selected_frequency=recurring">
              Begin a recurring donation
            </a>
          </main>
        </div>
      {% endif %}
    </div>

    <div class="w-full">
      <h2 class="text-wm-purple border-b-2 mb-4 border-b-wm-pink">Transactions</h2>

      <ol>
        {% if donations %}
          {% for donation in donations %}
              <li class="relative mt-2">
                <div class="py-2 px-4 rounded-xl border-[1px] border-wm-pink">
                  <div class="text-xl font-bold text-wm-purple flex items-center gap-4">
                    {{ donation.amt }}

                    <span class="text-sm font-bold text-wm-purple">
                      {% if donation.recurring %}recurring{% else %}one off{% endif %}
                    </span>
                  </div>

                  <div class="text-xs text-gray-500">{{ donation.created_at|date:"m/d/Y" }}</div>
                </div>

                <button type="button" class="absolute right-4 top-4 z-10">
                  <span aria-hidden="true" class="w-6 h-6 inline-block not-sr-only" title="Print">
                    {% include "./icon-print.html" %}
                  </span>
                  <span class="text-gray-500 sr-only">print receipt</span>
                </button>
              </li>
          {% endfor %}
        {% else %}
          <li class="text-gray-600 mb-4">
            No donations found.
          </li>
        {% endif %}
      </ol>
    </div>

    <div class="bg-wm-purple rounded my-4 p-8 w-full">
      <a
        class="hover:!no-underline max-w-96 m-auto uppercase p-4 text-center font-bold text-lg font-gilroy bg-wm-pink min-h-10 w-full !text-white block rounded transition-all hover:brightness-110"
        href="https://action.wemove.eu/donate/chip-in-wemove">
        Make a donation now!
      </a>
    </div>

    <div class="bg-gray-200 p-4 rounded-lg w-full mb-8">
      <h2 class="text-wm-purple border-b-2 border-b-gray-400">How we are funded</h2>
      <p>If you want to know more about how we are funded, how we use your donation, or other commonly asked question, you can visit this page.</p>
      <p>You can also contact us anytime if at: <a class="hover:underline transition-all" href="mailto:donation@wemove.eu">donation@wemove.eu</a></p>
    </div>
  </section>

{% endblock %}
