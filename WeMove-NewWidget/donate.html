{% extends "./wrapper.html" %}
{% block body_extra_classes %}wemove {% if page.payment_processor_information.is_oneclick %}actionkit-donate-fa {% endif %}{{ block.super }}{% endblock %}
{% block css_additions %}
{% load_css %}
    //actionkit-stripe-api.wemove.support/stripe/static/index.0e2b4833.css
{% end %}
{% endblock %}

{% block content %}
<style>
    label.ak-btn {
        max-width: revert;
    }
</style>

{% store as currency %}{% if request.GET.currency %}{{ request.GET.currency }}{% elif page.custom_fields.wemove_currency %}{{ page.custom_fields.wemove_currency }}{% else %}EUR{% endif %}{% endstore %}
{% store as currency_symbol %}{% if currency == 'EUR' %}€{% elif currency == 'PLN' %}zł{% elif currency == 'GBP' %}£{% else %}€{% endif %} {% endstore %}

<h1>{{ currency_info|json }}</h1>

<form id="act" name="act" class="{{ templateset.custom_fields.donation_steps }}" method="POST" action="/act/"
    accept-charset="utf-8">
    <input type="hidden" name="page" value="{{ page.name }}">
    <input type="hidden" name="orig_akid" value="{{ akid }}">

    <div class="ak-grid-row">
        <div class="ak-grid-col ak-grid-col-12-of-12">
            <h2>{{ page.title }}</h2>
        </div>
    </div>

    <div class="ak-grid-row">

        <div class="ak-grid-col ak-grid-col-6-of-12">

            <div id="page-data">
                <b>ActionKit Template Context</b>
                has_products {{ has_products }}<br />
                allow_monthly {{ allow_monthly }}<br />
                products {{ products }}<br />
                currency_symbol {{ currency_symbol }}<br />
                has_candidates {{ has_candidates }}<br />
                candidates {{ candidates }}<br />
                amounts {{ amounts }}<br />
                page {{ page }}<br />
                has_shippable_products {{ has_shippable_products }}<br />
                templateset.custom_fields {{ templateset.custom_fields }}<br />
                page.custom_fields {{ page.custom_fields }}<br />
                akid {{ akid }}<br />

                <b>JS window.actionkit</b>
                <span class="ak-object-info" />
                <script>
                    (function () {
                        var ak = window.actionkit || {};
                        console.log(ak);
                        document.querySelector('.ak-object-info').innerHTML = JSON.stringify(ak, null, 2);
                    })()
                </script>
            </div>

            {% if page.custom_fields.featured_image %}
            <img class="ak-featured-img" src="{{page.custom_fields.featured_image}}">
            {% endif %}
            <div>{% include "./progress_meter.html" %}</div>
            {% include_tmpl form.ask_text %}
        </div>
        <div class="ak-grid-col ak-grid-col-1-of-12"></div>

        <!-- donate-form-container -->
        <div class="ak-grid-col ak-grid-col-4-of-12 donate-form-container">
        </div>
        <!-- end donate-form-container -->

    </div>

</form>

{% store as next_step %}
{% if page.custom_fields.next_step %}/act/{{ page.custom_fields.next_step }}{% if '?' in page.followup.url %}&amp;{% else %}?{% endif %}akid={{ akid }}&amp;action={{ args.action }}{% elif page.custom_fields.daisy_chain_action %}/thanks/{{ page.custom_fields.daisy_chain_action }}?share=1&amp;akid={{ akid }}&amp;action={{ args.action }}{% endif %}{% endstore %}

{% if next_step %}
<div class="row">
    <br>
    <div class="col-md-12" style="text-align: center;">
        <a href="{{ next_step }}" class="skip btn btn-default"> {% filter ak_text:"skip_this_step" %}Skip this step{% endfilter %}</a>
    </div>
</div>
{% endif %}

<div class="row" id="other_ways_giving">
    <div class="col-md-12">
        <h3>Other ways of giving</h3>
        <div class="row">
            <div class="col-md-4">
                <p> <i>You can transfer your donation to our bank account</i></p>
                <p> <i>Please include your email address as payment reference</i> </p>
                <p>
                    WeMove Europe SCE mbH<br>
                    IBAN: DE98 4306 0967 1177 7069 00<br>
                    BIC: GENODEM1GLS, GLS Bank<br>
                    Berlin, Germany
                </p>
            </div>

            <div class="col-md-3">
                <!--Make a <b>recurring</b> donation
				<a href="https://www.wemove.eu/civicrm/contribute/transact?reset=1&id=83" title="Donate with PayPal" target="_blank">  <img src="https://www.wemove.eu/sites/wemove.eu/files/paypal.png" /></a>
				<p> </p>
				Make a <b>one-off</b> donation
				<a href="https://www.wemove.eu/civicrm/contribute/transact?reset=1&id=88" title="Donate with Paypal" target="_blank">  <img src="https://www.wemove.eu/sites/wemove.eu/files/paypal.png" /></a>
				</div>-->
            </div>

            <div class="col-md-5">
                We want to be transparent and accountable about how we spend your donations - for more information
                please see our
                <strong><a href="https://www.wemove.eu/how-we-are-funded" target="_blank">Donation Policy</a></strong>.
                <br>
                <br>
                Your personal information will be kept private and held securely. By submitting information you are
                agreeing to WeMove Europe keeping you informed about campaigns and agree to the use of cookies in
                accordance with our
                <strong><a href="https://www.wemove.eu/privacy-policy" target="_blank">privacy policy</a></strong>.
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script_additions %}

<script src="https://www.paypal.com/sdk/js?client-id=sb&disable-funding=credit,card&currency=USD"
    data-sdk-integration-source="button-factory"></script>
<script>
    window.ppInitialized = false;
    function initPayPalButton() {
        if (window.ppInitialized) return;
        paypal.Buttons({
            style: {
                shape: 'rect',
                color: 'gold',
                layout: 'vertical',
                label: 'paypal',
                height: 42
            },

            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{ "amount": { "currency_code": "USD", "value": 1 } }]
                });
            },

            onApprove: function (data, actions) {
                return actions.order.capture().then(function (orderData) {

                    // Full available details
                    console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));

                    // Show a success message within this page, e.g.
                    const element = document.getElementById('ak-paypal-button');
                    element.innerHTML = '';
                    element.innerHTML = '<h3>Thank you for your payment!</h3>';

                    // Or go to another URL:  actions.redirect('thank_you.html');

                });
            },

            onError: function (err) {
                console.log(err);
            }
        }).render('#ak-paypal-button');
        window.ppInitialized = true;
    }

</script>

<script language="javascript">
    //<!--
    function clear_radio_buttons() {
        $('input.ak-amount-radio-button').prop('checked', false);
    }

    function clear_other() {
        $('#ak-other-amount-field').val("");
    }

    function product_info(id) {
        var product_element = $("#product_" + id),
            quantity = 0,
            price = parseFloat($("#product_" + id + "_price").data("price"));

        if (product_element.is(':checkbox')) {
            if (product_element.is(':checked')) {
                quantity = 1;
            }
        } else if (product_element.val() != "") {
            quantity = parseInt(product_element.val());
        }

        return {
            'id': id,
            'price': price,
            'quantity': quantity,
            'subtotal': (price * quantity)
        }
    }

    function update_total() {
        var total = 0.0;

        product_infos().forEach(function (info) {
            total += info.subtotal;
        });

        $('.ak_candidate_inputs').each(function (i) {
            // check that amount is a valid amount
            var amount = this.value;
            if (amount.length == 0 || ! /^[\d,]*(\.\d{1,2})?$/.test(amount)) {
                return;
            }

            total += parseFloat(amount.replace(',', ''));
        });

        // look for checked off donation amounts
        var amount_checked = $('input:radio[name=amount]:checked').val();
        if (amount_checked) {
            total += parseFloat(amount_checked);
        } else {
            // or other amounts
            var other = $('#ak-other-amount-field').val();
            if (typeof other !== "undefined" &&
                other.length && /^[\d,]*(\.\d{1,2})?$/.test(other))
                total += parseFloat(other.replace(',', ''));
        }

        var new_total = total == 0 ? "" : "" + total.toFixed(2);
        $('.ak-donation-total-amount').html(new_total);
        return total;
    }

    $(function () {
        $('.ak_product_inputs').on('change blur', update_total);
        $('.ak_candidate_inputs').on('change blur', update_total);
        $('.ak-amount-radio-button').on('change blur', update_total)
            .on('click', clear_other)
            .on('click', update_total);
        $('#ak-other-amount-field').on('change blur', update_total)
            .on('click keyup', clear_radio_buttons)
            .on('click', update_total);
        $('input[type=radio][name=payment_method]').change(function () {
            $('.ach_payment_options').hide();
            $('.cc_payment_options').show();
        });

        $('#ak-ownership_type').change(function () {
            if (this.value == 'business') {
                $('#ak-fieldbox-business_name').show();
            } else {
                $('#ak-fieldbox-business_name').hide();
            }
        });
    });

    /* Amount buttons */
    function highlight_selected_amount_button() {
        $('label.ak-radio-checked').removeClass('ak-radio-checked');
        $(this).closest('label').addClass('ak-radio-checked');
    }
    $(function () {
        $('input[name="amount"]').on(
            'click', highlight_selected_amount_button);
        $('input[name="amount_other"]').on(
            'click change', highlight_selected_amount_button);

        // Make sure label is highlighted if an amount is pre-selected
        highlight_selected_amount_button.call(
            $('input[name="amount"]:checked').get(0) //||
            //$('input[name="amount_other"]').get(0)
        );
    });

    /* Currency symbols */
    function redraw_currency_symbol(element) {
        var iso_code = $(element).find('input:checked, option:selected').attr('value');
        var currency_sym = actionkit.utils.currencySymbols[iso_code];
        if (currency_sym) {
            $('.ak-currency-sym').text((currency_sym || '') + ' ');
        }
    }

    $(function () {
        var currency_switcher = $('input[id^=id_currency_], select[name="currency"], select[name="payment_account"]');
        currency_switcher.on('change', (e) => redraw_currency_symbol(e.target));
        redraw_currency_symbol(currency_switcher);
    });


    var address_fields = [
        'address1', 'address2', 'city', 'state', 'zip'
        {% if page.allow_international %}, 'postal', 'region', 'country'{% endif %}
    ];

    {% if page.allow_international %}
    function country_change() {
        if ($('#id_country').val() == 'United States') {
            $('.ak-us-billing-fields').show();
            $('.ak-intl-billing-fields').hide();
        } else {
            $('.ak-us-billing-fields').hide();
            $('.ak-intl-billing-fields').show();
        }
        sync_to_shipping();
    }
    function shipping_country_change() {
        if ($('#id_shipping_country').val() == 'United States') {
            $('.ak-us-shipping-fields').show();
            $('.ak-intl-shipping-fields').hide();
        } else {
            $('.ak-us-shipping-fields').hide();
            $('.ak-intl-shipping-fields').show();
        }
    }
    $(function () {
        $('#id_country').on('change blur', country_change);
        $('#id_shipping_country').on('change blur', shipping_country_change);
        country_change();
        shipping_country_change();
    });
    {% endif %}


    function toggle_shipping() {
        if ($('#ak-shipping-same').prop("checked")) {
            sync_to_shipping();
            $('#ak-shipping-fields').slideUp();
            if ($('.ak-shipping-required').length)
                $('.ak-shipping-required').remove();
        } else {
            clear_shipping();
            $('#ak-shipping-fields').slideDown();
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_address1' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_city' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_state' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_zip' class='ak-shipping-required'>");
        }
    }

    function clear_shipping(e) {
        var i, field, ship_field;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            ship_field.val("").change().prop("readonly", false);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    function sync_to_shipping(e) {
        if (!$('#ak-shipping-same').prop("checked")) {
            return;
        }
        var i, field, ship_field, bill_value;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            bill_value = $('#id_' + field).val();
            ship_field.val(bill_value).change().prop("readonly", true);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    $(function () {
        $('#ak-shipping-same').on('change', toggle_shipping);
        toggle_shipping();

        $('#id_address1, #id_address2, #id_city, #id_state, #id_zip, ' +
            '#id_region, #id_postal').on('change blur', sync_to_shipping);
    });

    var three_step_initialized = 0;
    function three_step_reveal() {
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        if (current_step != "2" && current_step != "3") {
            current_step = "1"
        }
        var speed = three_step_initialized ? 1 : 400;
        if (current_step == "1") {
            $('.ak-donate-area-step-2, .ak-donate-area-step-3, .amount-selected').hide();
            $('.ak-donate-area-step-1').fadeIn(speed);

        } else if (current_step == "2") {
            $('.ak-donate-area-step-1, .ak-donate-area-step-3, .amount-selected').hide();
            $('.ak-donate-area-step-2, .details-entered').fadeIn(speed,
                focus_field_if_blank($('#id_name'))
            );
        } else if (current_step == "3") {
            $('.ak-donate-area-step-1, .ak-donate-area-step-2, .details-entered').hide();

             WeMoveStripe.initializePaymentElement(
                  $('#act').get(0),
                  '#stripe-payment-card-element',
                  {
                    location: window.location,
                    currency: "{{ currency }}"
                  }
             );

            $('.ak-donate-area-step-3').fadeIn(speed);

            initPayPalButton();       }
    }

    function focus_field_if_blank(field_elt) {
        return (function () {
            if (!field_elt.val()) {
                field_elt.focus()
            }
        })
    }

    var step_has_errors = false;
    function three_step_advance() {
        // trigger validation on the step we're leaving
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        // hitting "back" after donating confuses our step navigation.
        // User gets dropped on first step, then browser autocomplete sets our step tracker field without us knowing.
        // So, check what step the UI's on, and if step tracker and UI disagree give precedence to the UI.
        var currentStepUI = $('div.ak-donate-area-step-1,div.ak-donate-area-step-2,div.ak-donate-area-step-3').filter(':visible');
        if (currentStepUI.length) {
            var uiStepNum = currentStepUI.attr('class')
                .match(/ak-donate-area-step-[0-9]/g)[0]
                .slice(-1);
            if (uiStepNum != current_step) {
                $('input[name=ak-donate-step][value=' + uiStepNum + ']').prop('checked', true);
                current_step = uiStepNum;
            }
        }
        validate_step(current_step);

        if (!step_has_errors) {
            $('input[name="ak-donate-step"]:checked').closest('label').
                next('label').find('input[type="radio"]').prop('checked', true);
            three_step_reveal();
        }
    }

    function three_step_goto(next) {
        // trigger validation on the step we're leaving
        var current_step = $('input[name="ak-donate-step"]:checked').val();

        // skip validation if we're going backwards
        if (current_step < next) {
            validate_step(current_step);
        }

        // can't skip over a step unless it's already been completed
        if ((!step_has_errors) && (current_step == 1) && (next == 3)) {
            validate_step(2);
            if (step_has_errors) {
                $('#ak-donate-step-2').prop('checked', true);
                three_step_reveal();
                return;
            }
        }

        // allow the user to go back even if there are errors
        if (current_step > next || !step_has_errors) {
            $('#ak-donate-step-' + next).prop('checked', true);
            three_step_reveal();
        }
    }

    function validate_product_count(field) {
        var product_count = field.value;
        if (product_count == "" || product_count == "0") {
            return true
        }
        product_count = parseInt(product_count);
        var product_max = parseInt($(field).attr('max'));
        if (product_max && product_count > product_max) {
            var err_msg = actionkit.forms.errorMessage('product:max');
            err_msg = err_msg.replace("{0}", product_max);
            return err_msg
        }
        return true
    }

    /* used to limit AK built-in validation to particular fields by step */
    var doing_step_validation = false;
    var validate_fields = [];
    function validate_step(step) {
        step_has_errors = false;
        if (step == "1") {
            validate_fields = ["amount"];
        } else if (step == "2") {
            validate_fields = ["email", "first_name", "last_name", "name",
                "address1", "address2", "city", "state", "zip",
                "country", "region", "postal",
                "shipping_address1", "shipping_address2",
                "shipping_city", "shipping_state",
                "shipping_zip", "shipping_country",
                "shipping_region", "shipping_postal",
                "privacy"
                               {% if has_candidates %}, "action_employer", "action_occupation"{% endif %}];
    } else {
        validate_fields = ["card_num", "card_code",
            "exp_date_year", "exp_date_month", "exp_date"];
    }

    doing_step_validation = true;
    actionkit.forms.validate();
    doing_step_validation = false;

    if (step == "1") {
        step_has_errors = step_1_validation();
    }

    if (step == "2" && !step_has_errors) {
        step_has_errors = step_2_validation();
    }


    if (step == "3" && !step_has_errors) {
        step_has_errors = step_3_validation();
    }
    }

    function do_validate_credit_card() {
        if (actionkit.donations && actionkit.donations.skip_cc_validation) {
            return false;
        }

        return true;
    }

    function step_3_validation() {
        var step_has_errors = false;
        if (!actionkit.errors) {
            actionkit.errors = {};
        }

        var payment_method = actionkit.form["payment_method"] && actionkit.form["payment_method"].value;
        if (actionkit.donations && actionkit.donations.vgs) {
            actionkit.donations.vgs.validateHostedForm().map(function (error) {
                actionkit.donations.vgs.handleError(error);
                step_has_errors = true;
            });
        } else {
            if (!do_validate_credit_card()) {
                return step_has_errors;
            }

            if (!valid_credit_card($('#ak-card_num').val())) {
                actionkit.errors['card_num:invalid'] = actionkit.forms.errorMessage('card_num:invalid');
                step_has_errors = true;
            }

            if (!valid_credit_card_code($('#ak-card_code').val())) {
                actionkit.errors['card_code:invalid'] = actionkit.forms.errorMessage('card_code:invalid');
                step_has_errors = true;
            }
        }

        if (step_has_errors) {
            actionkit.forms.onValidationErrors(actionkit.errors);
        }

        return step_has_errors;
    }

    function step_2_validation() {
        var step_has_errors = false;
        if (!valid_email($('#id_email').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['email:invalid'] = actionkit.forms.errorMessage('email:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }
        return step_has_errors;
    }

    function step_1_validation() {
        var step_has_errors = false;

        // look for product selections
        var selected_products = false;
        product_infos().forEach(function (info) {
            if (info.quantity) {
                selected_products = true;
            }
        });

        // look for candidate selections
        var selected_candidates = false;
        $('.ak_candidate_inputs').each(
            function (i) {
                if ($(this).val() != "")
                    selected_candidates = true;
            });

        // there's no built-in validation for amounts, so do it here
        if (!selected_products && !selected_candidates &&
            !$('.ak-amount-radio-button').is(':checked') &&
            $('#ak-other-amount-field').val() == "") {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['amount:missing'] = actionkit.forms.errorMessage('amount:missing');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;

        } else if (($('#ak-other-amount-field').val() != "" &&
            $('#ak-other-amount-field').val() != undefined) &&
            !/^[\d,]*(\.\d{1,2})?$/.test($('#ak-other-amount-field').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['amount:invalid'] = actionkit.forms.errorMessage('amount:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }

        {% if page.minimum_amount %}
        var total = update_total();
        if (!step_has_errors && total < {{ page.minimum_amount }
    }) {
        if (!actionkit.errors) {
            actionkit.errors = {};
        }
        err = actionkit.forms.errorMessage('amount:minimum');
        err = err.replace("{0}", "{{ page.minimum_amount }}");
        actionkit.errors['amount:minimum'] = err;
        actionkit.forms.onValidationErrors(actionkit.errors);
        step_has_errors = true;
    }
    {% endif %}

    return step_has_errors;
    }

    function actionkitValidationErrors(errors, field) {
        // only want this running during step validation
        if (!doing_step_validation) {
            return;
        }

        // trim out validation errors we don't care about on this step
        var to_delete = [];
        step_has_errors = false;
        for (var key in errors) {
            parts = key.split(':');
            if (validate_fields.indexOf(parts[0]) == -1) {
                to_delete.push(key);
            } else {
                step_has_errors = true;
            }
        }
        for (var i = 0; i < to_delete.length; i++) {
            delete errors[to_delete[i]];
        }
    }

    function three_step_initialize() {
        if (actionkit.errors) {
            var has_errors = [];
            if ($('.ak-donate-area-step-1').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-1'));
            }
            if ($('.ak-donate-area-step-2').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-2'));
            }
            if ($('.ak-donate-area-step-3').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-3'));
            }

            if (has_errors.length == 1) {
                // just one pane with errors?  show it
                has_errors[0].show();
            } else {
                // otherwise show all steps
                $('.ak-donate-area-step-1, .ak-donate-area-step-2, .ak-donate-area-step-3').show();
                $('#ak-continue-button, .ak-donate-three-step-visible').hide();
            }
        }
        three_step_initialized = 1;
    }

    $(function () {
        // three-step vs. one-step UI
        if ($('form.ak-donate-three-step').length == 0) {
            $('.ak-donate-three-step-visible').hide();
        } else {
            $('.ak-donate-three-step-hidden').hide();
            three_step_reveal();
            window.actionkitFormReady = three_step_initialize;
            // $('.ak-donate-menu input[type="radio"]').on('change', three_step_reveal);
            $('.amount-selected, .details-entered').on('click', function (evt) {
                // letting this event go will trigger our onsubmit and lead to validation woe
                evt.preventDefault();
                three_step_advance();
            });
            $('.ak-donate-step-1').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('1');
            });
            $('.ak-donate-step-2').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('2');
            });
            $('.ak-donate-step-3').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('3');
            });
            $('.amount-btn').on('click', function (evt) {
                three_step_advance();
            });
        }

    });

    function product_ids() {
        return $("[data-product]").map(function (i, el) {
            return $(el).data("product");
        }).toArray();
    }

    function product_infos() {
        return product_ids().map(function (id) {
            return product_info(id);
        });
    }

    // calculate subtotals if products exist
    function calculate_product_subtotals() {
        var subtotal = 0;
        product_infos().forEach(function (info) {
            $('.ak_product_subtotal_' + info.id).text(info.subtotal.toFixed(2));
            subtotal += info.subtotal;
        });
        $('#ak-donation-subtotal-amount').text(subtotal.toFixed(2));
    }

    $(function () {
        calculate_product_subtotals();

        $('.ak_product_inputs').on('change', function () {
            calculate_product_subtotals();
        });
    });

    // Standard luhn check to detect mistyped credit card numbers
    // from https://gist.github.com/DiegoSalazar/4075533
    function valid_credit_card(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        var nCheck = 0, nDigit = 0, bEven = false;
        value = value.replace(/\D/g, "");

        for (var n = value.length - 1; n >= 0; n--) {
            var cDigit = value.charAt(n),
                nDigit = parseInt(cDigit, 10);

            if (bEven) {
                if ((nDigit *= 2) > 9) {
                    nDigit -= 9;
                }
            }

            nCheck += nDigit;
            bEven = !bEven;
        }

        return (nCheck % 10) == 0;
    }

    function valid_credit_card_code(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        value = value.replace(/\D/g, "");
        if (value.length == 3 || value.length == 4) {
            return true;
        }
        return false;
    }

    function valid_bank_account_number(value) {
        return /^\d{4,17}$/.test(value);
    }

    function valid_bank_routing_number(value) {
        value = value.replace(/\D/g, '');

        if (value.length != 9) { return false; }

        var checksum = 0;
        for (var i = 0; i < value.length; i += 3) {
            checksum += parseInt(value.charAt(i), 10) * 3
                + parseInt(value.charAt(i + 1), 10) * 7
                + parseInt(value.charAt(i + 2), 10);
        }

        if (checksum == 0 || checksum % 10 != 0) { return false; }

        return true;
    }

    // not 100% the same as Django but pretty close
    var email_regExp = /^\s*((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\s*$/i;
    function valid_email(email) {
        return email_regExp.test(email);
    }

    function submit_paypal() {
        {% if page.paypal_user_requirements != "none" %}
        {% if page.paypal_user_requirements == "email" %}
        validate_fields = ["email", "privacy"];
        {% else %}
        validate_fields = [
            "email", "first_name", "last_name", "name",
            "address1", "address2", "city", "state", "zip",
            "country", "region", "postal",
            "shipping_address1", "shipping_address2",
            "shipping_city", "shipping_state",
            "shipping_zip", "shipping_country",
            "shipping_region", "shipping_postal", "privacy"
                    {% if has_candidates %}, "action_employer", "action_occupation"{% endif %}
               ];
    {% endif %}

    doing_step_validation = true;
    actionkit.forms.validate();
    doing_step_validation = false;
    if (!$.isEmptyObject(actionkit.errors)) {
        return false;
    }
    {% endif %}

    /* set the paypal=1 hidden field */
    $('#ak-pay-by-paypal').val(1);

    /* clear out CC info if entered */
    $('#ak-card_num').val('');
    $('#ak-card_code').val('');

    /* disable CC requirements */
    $('#ak-card_num-required').remove();
    $('#ak-card_code-required').remove();
    $('#ak-exp_date_month-required').remove();
    $('#ak-exp_date_year-required').remove();

    /* and keep submitting */
    return true;
    }

    function submit_cc() {
        /* clear paypal=1 hidden field, only needed if someone hit back */
        $('#ak-pay-by-paypal').val(0);

        if ($('button.ak-submit-button').hasClass('is-submitted')) {
            return false
        }

        if ($('form.ak-donate-three-step').length > 0) {
            validate_step("3");

            if (step_has_errors) {
                return false;
            } else {
                $('button.ak-submit-button').addClass('is-submitted');


                /* Get a Stripe Checkout Session and send the user there. */


            }
        }


        /* not doing 3-step, so we need to do all the validation here,
         * don't want to short-circuit and only run one step, better
         * to run all three even if all three have errors */
        actionkit.forms.validate();
        results = [step_1_validation(),
        step_2_validation(),
        step_3_validation()];
        var ok = !(results[0] || results[1] || results[2]);
        if (ok) {
            $('button.ak-submit-button').addClass('is-submitted');
        }
        return ok
    }

    $(function () {
        $('#ak-paypal-button').on('click', submit_paypal);
        $('.ak-submit-button').on('click', submit_cc);
        $(window).on('pagehide', function () {
            $('button.ak-submit-button').removeClass('is-submitted');
        });

        {% if page.paypal_user_requirements == "none" %}
        $('#ak-paypal-button').on('mousedown', function () {
            var form_elt = $(this).closest('form');
            var required_fields = form_elt.find('input[name="required"]');
            if (required_fields.length) {
                required_fields.remove();
                $('body').on('mouseup', function (event) {
                    form_elt.append(required_fields);
                    $(this).unbind(event);
                });
            }
        });
        {% endif %}
    });

//-->
</script>

{% with page.payment_processor_information as pp %}
{% if pp.use_accept %}
<script src="/resources/ak_authnet_accept.js"></script>
{% authnet_js_libs %}
<script>
    $(function () {
        var form = document.querySelector("#act"),
            options = {
                form: form,
                submit: form.querySelector(".ak-submit-button")
            };
        actionkit.authnet.initClient('{{ pp.login }}', '{{ pp.public_key }}', options);
    });
</script>
{% endif %}

{% endwith %}

{% comment %}
WeMove Stripe Code
{% endcomment %}
<script type="module" async src="https://actionkit-stripe-api.wemove.support/stripe/static/index.4924a4c5.js"></script>


// debuggin code
$( () => {
    $('#id_amount_5').click();
    $('#act input[name="email"]').val('someone@example.com');
    $('#id_country > option:nth-child(14)').prop('selected', true);
    $('#id_address1').val('996 West Nobel Drive');
    $('#id_name').val('Jin Grant');
    $('#id_postal').val('3-19 N');
    $('#id_city').val('Dusseldorf');
});
</script>
{% endblock %}

{% block below_form %}
{% if page.payment_processor_information.is_quickdonate %}
{% load_quickdonate %}
{% endif %}
{{ block.super }}
{% endblock %}